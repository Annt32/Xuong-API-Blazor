@page "/FieldShifts"
@using AppData.DTO
@using AppData.DTO.User_RoleDto
@using AppData.Entities
@using BlazorServer.IServices
@using BlazorServer.Models
@using AppData.Enum

@inject IFieldService FieldService
@inject IShiftService ShiftService
@inject IFieldShiftService FieldshiftService
@inject IServices<WebUser> UserService
@inject IJSRuntime JS
<h3>Quản Lý Ca Sân Bóng</h3>

<style>
    button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
        background-color: #d3d3d3; /* Màu xám nhạt */
        color: #ffffff; /* Trắng */
        border-color: #d3d3d3; /* Màu viền xám nhạt */
    }

</style>

<div class="row">
    <!-- Thông Tin Sân Bóng -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <strong>Thông Tin</strong>
            </div>
            @if (b==false)
            {
                <p>Ca Ban Xoa Da Co Hoa Don</p>
            }
            <EditForm Model="@fieldShift" OnValidSubmit="HandleSubmit" OnInvalidSubmit="HandleInvalidSubmit">
                <DataAnnotationsValidator />
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert @((errorMessage.Contains("thành công") ? "alert-success" : "alert-danger"))" role="alert">
                        @errorMessage
                    </div>
                }

                <div class="form-group">
                    <label for="FieldShift">Chọn Sân</label>
                    <select id="FieldShift" class="form-control" @bind="fieldShiftVM.IdField">
                        <option value="">-- Chọn Sân --</option>
                        @foreach (var field in fieldShifts)
                        {
                            <option value="@field.IdField">@field.FieldName</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label for="Shift">Chọn Ca</label>
                    <select id="Shift" class="form-control" @bind="fieldShiftVM.IdShift">
                        <option value="">-- Chọn Ca --</option>
                        @foreach (var shift in shifts)
                        {
                            <option value="@shift.IdShift">@shift.ShiftName @shift.StartTime-@shift.EndTime</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label for="Date">Chọn Ngày</label>
                    <input type="date" id="Date" class="form-control" @bind="fieldShift.Time" />
                    <ValidationMessage For="@(() => fieldShift.Time)" />
                </div>

                <div class="form-group">
                    <label for="CustomerPhone">Số điện thoại khách hàng</label>
                    <div class="input-group">
                        <input type="text" id="CustomerPhone" class="form-control" @bind="customerPhoneNumber" placeholder="Nhập số điện thoại" />
                        <div class="input-group-append">
                            <button type="button" class="btn btn-success ml-2" @onclick="CheckCustomer">Kiểm tra</button>
                        </div>
                    </div>
                </div>



                @if (selectedCustomer != null)
                {
                    <div class="mt-3">
                        <p><strong>Khách hàng:</strong> @selectedCustomer.FullName</p>
                        <p><strong>Số điện thoại:</strong> @selectedCustomer.PhoneNumber</p>
                    </div>
                }

                <div class="form-group">
                    @if (fieldShift.IdFieldShift == Guid.Empty)
                    {
                        <button type="submit" class="btn btn-primary">Tạo</button>
                    }
                    else
                    {
                        <button type="submit" class="btn btn-warning">Cập Nhật</button>
                    }
                </div>
            </EditForm>
        </div>
    </div>

    <!-- Danh Sách Sân -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <strong>Danh Sách Ca Sân</strong>
                <div class="input-group mt-2">
@*                     <input type="text" class="form-control" placeholder="Tìm kiếm tên sân bóng..." @bind="searchText" />
 *@                    <div class="input-group-append">
                       @*  <button class="btn btn-secondary" @onclick="SearchFields">
                            <i class="fas fa-search"></i> Tìm Kiếm
                        </button> *@
                    </div>
                </div>
            </div>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Người đặt</th>
                            <th>SDT</th>
                            <th>Sân</th>
                            <th>Ngày</th>
                            <th>Ca</th>
                            <th>Thời gian</th>
                            <th>Trạng Thái</th>
                            <th>Thao Tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (fieldShiftViewModels == null || !fieldShiftViewModels.Any())
                        {
                            <tr>
                                <td colspan="9" class="text-center">Đang tải dữ liệu...</td>
                            </tr>
                        }
                        else
                        {
                            int index = 0;
                            @foreach (var item in fieldShiftViewModels)
                            {
                                <tr>
                                    <td>@(++index)</td>
                                    <td>@item.CustomerFullName</td>
                                    <td>@item.CustomerPhoneNumber</td>

                                    <td>@item.FieldName</td>
                                    <td>@item.Time.ToString("dd/MM/yyyy")</td>
                                    <td>@item.ShiftName</td>
                                    <td>@item.StartTime (@item.EndTime)</td>
                                
                                    <td>@item.Status</td>
                                    <td>
                                        <button class="btn btn-info" @onclick="() => EditField(item.IdFieldShift)">
                                            <i class="fas fa-edit"></i> Sửa
                                        </button>
                                        <button class="btn btn-danger" @onclick="() => ConfirmDelete(item.IdFieldShift)">
                                            <i class="fas fa-trash-alt"></i> Xóa
                                        </button>

                                        <!-- Nút CheckIn chỉ hiện khi Status == 1 -->
                                        <button class="btn btn-success" @onclick="() => ConfirmCheckIn(item.IdFieldShift)" hidden="@(item.Status != FieldShiftStatus.WaitingForCheckin)">
                                            CheckIn
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>

                </table>
            </div>
        </div>
    </div>
</div>

@code {
    private List<FieldShiftViewModel> fieldShiftViewModels = new List<FieldShiftViewModel>();
    private FieldShiftViewModel fieldShiftVM = new FieldShiftViewModel();
    private FieldShiftViewModel fieldShift = new FieldShiftViewModel();
    private List<WebUser> customers = new List<WebUser>();
    private List<FieldViewModel> fieldShifts = new List<FieldViewModel>(); 
    private List<ShiftViewModel> shifts = new List<ShiftViewModel>(); 

    private Guid selectedCustomerId;  // Lưu ID khách hàng đã chọn
    private WebUser selectedCustomer;
    private string customerPhoneNumber;

    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var allFieldshifts = await FieldshiftService.GetAllFieldshiftAsync();
        customers = await UserService.GetAllFieldsAsync();
        fieldShifts = await FieldService.GetAllFieldsAsync();
        shifts = await ShiftService.GetAllShiftsAsync();

        // Thực hiện load dữ liệu ban đầu
        fieldShiftViewModels = (await Task.WhenAll(allFieldshifts.Select(async f =>
        {
            var shift = await ShiftService.GetShiftByIdAsync(f.IdShift);
            var field = await FieldService.GetFieldByIdAsync(f.IdField);
            var customer = await UserService.GetFieldByIdAsync(Guid.Parse(f.CreatedBy));

            return new FieldShiftViewModel
                {
                    IdFieldShift = f.IdFieldShift,
                    IdField = f.IdField,
                    IdShift = f.IdShift,
                    ShiftName = shift?.ShiftName ?? "Unknown",
                    FieldName = field?.FieldName ?? "Unknown",
                    Time = f.Time,
                    StartTime = shift?.StartTime ?? "Zero",
                    EndTime = shift?.EndTime ?? "Zero",
                    Status = f.Status,
                    CreatedAt = f.CreatedAt,
                    UpdatedAt = f.UpdatedAt,
                    CustomerFullName = customer?.FullName ?? "Unknown",
                    CustomerPhoneNumber = customer?.PhoneNumber ?? "Unknown"
                };
        }))).ToList();
    }


    private async Task CheckCustomer()
    {
        // Kiểm tra khách hàng dựa vào số điện thoại đã nhập
        selectedCustomer = customers.FirstOrDefault(c => c.PhoneNumber == customerPhoneNumber);

        if (selectedCustomer == null)
        {
            errorMessage = "Không tìm thấy khách hàng với số điện thoại này.";
        }
        else
        {
            errorMessage = string.Empty;
            selectedCustomerId = selectedCustomer.Id; // Lưu ID khách hàng đã chọn
        }
    }


    private async Task<string> GetShiftName(Guid idShift)
    {
        var shift = await ShiftService.GetShiftByIdAsync(idShift);
        return shift?.ShiftName ?? "Unknown";
    }

    private async Task<string> GetFieldName(Guid idField)
    {
        var field = await FieldService.GetFieldByIdAsync(idField);
        return field?.FieldName ?? "Unknown";
    }

    private async Task<WebUser> GetUserById(Guid Id)
    {
        var user = await UserService.GetFieldByIdAsync(Id);
        return user;
    }

    private async Task CheckIn(Guid idFieldShift)
    {
        var fieldShift = fieldShiftViewModels.FirstOrDefault(f => f.IdFieldShift == idFieldShift);
        if (fieldShift != null)
        {
            fieldShift.Status = FieldShiftStatus.Renting;  // Đang thuê
            await FieldshiftService.UpdateFieldshiftAsync(fieldShift.IdFieldShift, new FieldShiftDTO
                {
                    IdFieldShift = fieldShift.IdFieldShift,
                    IdShift = fieldShift.IdShift,
                    Status = FieldShiftStatus.Renting,
                    CreatedAt = fieldShift.CreatedAt,
                    UpdatedAt = DateTime.Now,
                    CreatedBy = fieldShift.CreatedBy,
                    UpdatedBy = "User"
                });
        }
    }

    private async Task ConfirmCheckIn(Guid idFieldShift)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirmAction", "Bạn có chắc chắn muốn CheckIn sân bóng này?");
        if (confirmed)
        {
            await CheckIn(idFieldShift);
        }
    }

    private async Task HandleSubmit()
    {
        if (selectedCustomerId == Guid.Empty)
        {
            errorMessage = "Vui lòng kiểm tra và chọn khách hàng trước khi tạo đặt sân.";
            return;
        }

        // Kiểm tra trùng ca, sân và user
        bool isDuplicate = fieldShiftViewModels.Any(f =>
            f.IdField == fieldShiftVM.IdField &&
            f.IdShift == fieldShiftVM.IdShift &&
            f.Time.Date == fieldShift.Time.Date);

        if (isDuplicate)
        {
            errorMessage = "Không thể đặt sân. Ca và sân đã được đặt hoặc khách hàng đã có đặt sân trong cùng thời gian.";
            return;
        }

        var newFieldShift = new FieldShiftDTO
            {
                IdFieldShift = Guid.NewGuid(),
                IdShift = fieldShiftVM.IdShift,
                IdField = fieldShiftVM.IdField,
                Time = fieldShift.Time,
                Status = FieldShiftStatus.WaitingForCheckin,
                CreatedBy = selectedCustomerId.ToString(),
                CreatedAt = DateTime.Now,
                UpdatedAt = DateTime.Now
            };

        Console.WriteLine("Time: " + newFieldShift.Time);
        var result = await FieldshiftService.CreateFieldshiftAsync(newFieldShift);

        if (result)
        {
            errorMessage = "Thêm thành công!";
            await OnInitializedAsync(); // Tải lại danh sách sau khi thêm mới
        }
        else
        {
            errorMessage = "Có lỗi xảy ra.";
        }
    }

    private void HandleInvalidSubmit()
    {
        // Xử lý khi form không hợp lệ
    }

    private void EditField(Guid idFieldShift)
    {
        // Thực hiện logic khi chỉnh sửa
    }

    
    bool b=true;

    private async Task ConfirmDelete(Guid id)
    {
        
    }

}